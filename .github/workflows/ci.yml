name: ci

on:
  pull_request:
  push:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: .python-version

      - name: Set up uv
        uses: astral-sh/setup-uv@v6

      - name: Sync dependencies
        run: uv sync

      - name: Lint (ruff)
        run: uv run ruff check .

  typecheck:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: .python-version

      - name: Set up uv
        uses: astral-sh/setup-uv@v6

      - name: Sync dependencies
        run: uv sync

      - name: Type check (ty)
        run: uv run ty check

  generated-code-quality:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: .python-version

      - name: Set up uv
        uses: astral-sh/setup-uv@v6

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install google-java-format
        run: |
          mkdir -p "$HOME/.local/bin" "$HOME/.local/share"
          curl -sSL \
            -o "$HOME/.local/share/google-java-format.jar" \
            "https://github.com/google/google-java-format/releases/download/v1.25.2/google-java-format-1.25.2-all-deps.jar"
          cat > "$HOME/.local/bin/google-java-format" <<'SH'
          #!/usr/bin/env bash
          exec java -jar "$HOME/.local/share/google-java-format.jar" "$@"
          SH
          chmod +x "$HOME/.local/bin/google-java-format"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Sync dependencies
        run: uv sync

      - name: Generated-code quality (java/rust)
        run: uv run python scripts/check_generated_code_quality.py --families all --seed 42 --count-per-family 2 --pool-size 24

  test-full:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: .python-version

      - name: Set up uv
        uses: astral-sh/setup-uv@v6

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Sync dependencies
        run: uv sync

      - name: Test (full verification)
        run: uv run pytest tests/ -v --verification-level=full -n auto --dist=worksteal
